import*as THREE from"three";import gsap,{CustomEase}from"gsap";class AnimatedChar{constructor({scene:e,camera:t,loader:i,modelPath:s,modelTexturePath:n,charName:o,customMaterial:a}){this.scene=e,this.camera=t,this.loader=i,this.modelPath=s,this.modelTexturePath=n,this.charName=o,this.customMaterial=a,this.modelTexture=null,this.model=null,this.neck=null,this.waist=null,this.possibleAnims=null,this.mixer=null,this.idle=null,this.clock=new THREE.Clock,this.currentlyAnimating=!1,this.raycaster=new THREE.Raycaster,this.loaderAnim=document.getElementById("js-loader"),this.actions=null,this.api={state:"happy_walk"},this.previousAction=null,this.activeAction=null,this.theTemplateCap=null,this.textureLoader=new THREE.TextureLoader,this.init(),this.setupEventListeners()}init(){var e=this;e.loader.load(e.modelPath,(t=>{e.model=t.scene,e.animations=t.animations,e.model.rotation.y=4*Math.PI;let i=t.animations;if(e.model.traverse((t=>{if(console.log(t.name),t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0),t.name,"head001"===t.name&&t.scale.set(1,10,1),"cap001"===t.name){const i=1.2;t.scale.set(i,i,i),e.theTemplateCap=t,t.visible=!1,console.log("cap mesh"),console.log(t)}t.isBone&&"mixamorigNeck"===t.name&&(this.neck=t),t.isBone&&"mixamorigSpine"===t.name&&(this.waist=t),t.name})),console.log("this.charName"),console.log(this.charName),"stacey"===this.charName)e.model.scale.set(.05,.05,.05),e.model.position.x=3;else if("Mixamo"===this.charName)e.model.scale.set(1,1,1),e.model.position.x=3;else if("nielskonrad"===this.charName){let t=1.1;e.model.scale.set(t,t,t)}let s=new THREE.Group;s.add(e.model),this.scene.add(s),s.rotation.z=4*Math.PI,this.mixer=new THREE.AnimationMixer(e.model),e.actions={};for(let t=0;t<e.animations.length;t++){const i=e.animations[t],s=e.mixer.clipAction(i);e.actions[i.name]=s,console.log("the animations"),console.log(e.actions)}let n=i.filter((e=>"idle"!==e.name));e.possibleAnims=n.map((e=>{let t=THREE.AnimationClip.findByName(n,e.name);return t.tracks.splice(3,3),t.tracks.splice(9,3),t=this.mixer.clipAction(t),t})),console.log("animations"),console.log(i[0].duration);let o=THREE.AnimationClip.findByName(i,"standing_playing");o.tracks.splice(3,3),o.tracks.splice(9,3),this.idle=this.mixer.clipAction(o),e.activeAction=e.actions.idle,e.activeAction.play()}),void 0,(function(e){console.error(e)}))}fadeToAction(e,t){var i=this;i.previousAction=i.activeAction,i.activeAction=i.actions[e],console.log("self.actions[ name ]"),console.log(i.actions[e]),console.log("- - - - name - - - - ]"),console.log(e),i.previousAction!==i.activeAction&&i.previousAction.fadeOut(t),gsap.to(i.model.position,1,{z:1.5,ease:"none",delay:.1}),i.activeAction.reset().setEffectiveTimeScale(1).setEffectiveWeight(1).fadeIn(t).play(),"happy_walk"===e&&setTimeout((()=>{this.fadeToAction("standing_playing",.4)}),1e3)}update(){this.mixer&&this.mixer.update(this.clock.getDelta())}raycast(e,t=!1){var i={};t?(i.x=e.changedTouches[0].clientX/window.innerWidth*2-1,i.y=1-e.changedTouches[0].clientY/window.innerHeight*2):(i.x=e.clientX/window.innerWidth*2-1,i.y=1-e.clientY/window.innerHeight*2),this.raycaster.setFromCamera(i,this.camera);var s=this.raycaster.intersectObjects(this.scene.children,!0);s[0]&&"stacy"===s[0].object.name&&(this.currentlyAnimating||(this.currentlyAnimating=!0,this.playOnClick()))}playOnClick(){let e=Math.floor(Math.random()*this.possibleAnims.length)+0;this.playModifierAnimation(this.idle,.25,this.possibleAnims[e],.25)}playModifierAnimation(e,t,i,s){i.setLoop(THREE.LoopOnce),i.reset(),i.play(),e.crossFadeTo(i,t,!0),setTimeout((()=>{e.enabled=!0,i.crossFadeTo(e,s,!0),this.currentlyAnimating=!1}),1e3*i._clip.duration-1e3*(s+t))}getMousePos(e){return{x:e.clientX,y:e.clientY}}moveJoint(e,t,i){let s=this.getMouseDegrees(e.x,e.y,i);t.rotation.y=THREE.Math.degToRad(s.x),t.rotation.x=THREE.Math.degToRad(s.y)}getMouseDegrees(e,t,i){let s,n,o,a,l=0,c=0,r=window.innerWidth,h=window.innerHeight;return e<=r/2&&(s=r/2-e,n=s/(r/2)*100,l=i*n/100*-1),e>=r/2&&(s=e-r/2,n=s/(r/2)*100,l=i*n/100),t<=h/2&&(o=h/2-t,a=o/(h/2)*100,c=.5*i*a/100*-1),t>=h/2&&(o=t-h/2,a=o/(h/2)*100,c=i*a/100),{x:l,y:c}}callAnimationFromParent(){this.fadeToAction(this.api.state,.5)}onKeyUp(e){var t=this;console.log("the pressed key"),console.log(e),"k"===e.key&&t.fadeToAction(t.api.state,.5),"i"===e.key&&t.fadeToAction("idle",.5)}setupEventListeners(){var e=this;window.addEventListener("click",(e=>this.raycast(e))),window.addEventListener("touchend",(e=>this.raycast(e,!0))),window.addEventListener("keyup",(e=>this.onKeyUp(e))),document.addEventListener("mousemove",(function(t){var i=e.getMousePos(t);this.neck&&this.waist&&(this.moveJoint(i,this.neck,50),this.moveJoint(i,this.waist,30))}))}}export default AnimatedChar;